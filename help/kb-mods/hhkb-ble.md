# HHKB BLE Mod

<table_w30x70>

|PCB | YANG |
|:--- |:--- |
|Firmware | YANG |
|Keymap Editor | YANG |
|Solder | YANG / 兰某人 |
|Test | YANG / 兰某人 |
|Seller | YANG / KBDFans |

</table_w30x70>

在售：https://item.taobao.com/item.htm?id=590221409485

安装可参考：https://www.chiphell.com/thread-2026980-1-1.html ，以及淘宝说明上有必要的注意事项。
  
熟悉hasu的tmk主控的，这个应该不用多介绍。简单说就是省电优化版吧，硬件的省电来源于两点，一个是蓝牙使用ble模块，另一个是工作电压不再需要5v，也就不需要升压了。软件的省电来源于根据硬件特点去制定的省电策略。这两者加起来，续航比hasu版的bt controller提高可能6到10倍或不止。但依然的最大的功臣还是他（整个HHKB键盘部分的扫描工作原理），我只是站在前人的成果上，完善产品。

BLE部分参照本help文档前面的说明，这里主要再说一些HHKB BLE Mod特殊的地方。 

注：本部分内容针对的是ydkb.io的最新版本固件。

固件的更新记录可见：[HHKB BLE固件更新记录](changelog/hhkb_ble)

## 蓝牙配对

蓝牙配对主要参看，[BLE双模使用](ble-series)

简单说不需要单独启用配对模式，只要蓝牙处于未连接并且可发现状态，就可以配对。mac和ios的搜不到在上面文档里也有写处理方法，另外出现连接异常时，也有处理方法。

## 开关说明

在原来的dip开关位置，有一个拨动开关。这也是HHKB BLE主控的惟一一个开关。
<html><div class="attention"> 
<subtitle>注意：</subtitle>
<ul><li>此开关的作用是关闭电池的对外供电，并不是关闭蓝牙。</li>
<li>因此，关闭时，如果插上USB线，因为还有USB供电，所以蓝牙依然可以工作。</li></ul>
</div></html>

直接用盖子可以很方便的拨到开关，靠近USB接口（下图向左）是开，远离USB接口（下图向右）是关。在键盘出现工作异常时，也需要将开关先关闭再打开，让键盘重新上电启动。

<div style="width: 600px">

![](/assets/hhkb_ble_sw.jpg?600)
</div>

如果想要关闭蓝牙功能，请参看[蓝牙开关和连接状态](ble-series/connection-status)。

<html><div class="hint">
<subtitle>提醒</subtitle>
<ul><li>此软件开关是给想要完全关闭蓝牙，仅使用或仅暂时使用有线模式而设计。建议同时把主控上的硬件电池开关也关掉。</li>
<li>它不是用来日常关闭蓝牙从而节能的，在HHKB上，使用这个功能关闭蓝牙，待机时比正常的二级节能时耗电很多。</li></ul>
</div></html>


## 充电注意

充电接口和数据接口，都是HHKB上的小的那个USB接口，不是两个大的USB母口。

<html><div class="attention">
<subtitle>注意：建议使用电脑USB口或者正规的5v充电器来充电</subtitle>
<br>使用大功率充电器并不会提高充电速度的，默认充电电流大部分为400多ma。即，在USB供电充足的情况下，2500mAh电池充满电需要6小时左右。。如果使用支持快充或非合适充电器，充电电压过高或瞬时过高，可能损坏充电IC等。
</div></html>

充电指示灯在左边那个USB HUB口下方的红灯(非正面的红灯)，从后面可以看到。如果是蓝色PCB的2.5版主控，充电指示灯默认用的蓝灯。

<table_w30x70>

| 充电指示灯状态 | 指示说明 |
|:--- |:--- |
| 低亮度或闪烁 | 表示电池异常（没接电池或电池有问题） |
| 较高亮度 | 表示充电中 |
| 熄灭或极低亮度 | 表示电池充满了，充满了会自动停止充电的 |

</table_w30x70>

一般不用刻意去注意这个指示灯，充过一次电后就能知道大概需要充多久了。

电量百分比显示，显示的是大概的水平，不是精确的，仅供参考（特别是充电时显示的误差会更大），每10%为一个等级。另外充电的过程中，电量显示为x1%，即比非充电时多显示1%。如下图是正在充电时显示的电量。

<div style="width: 450px">

![](/assets/hhkb-ble-charge.png?450)
</div>  

在电量达到90%以后，会进入涓流充电。充满之后，主控上本身的充电指示灯也会熄灭或者亮度降到极低，并且不再对电池进行充电。长期插着线使用是没有问题的。

Mac屏蔽了第三方蓝牙设备的电量显示，可以使用文字输出电量的功能，具体见： [充电与电量显示](ble-series/blebattery)。

## 固件设置和更新

打开网址https://ydkb.io ，选择好键盘 **HHKB BLE**，然后页面上就有刷的方式[Mass Storage Device Bootloader（U盘模式）](bootloader/msd-bootloader)。按键编辑器的说明参看本文档的其他部分。

除了按住左上角键（一般是ESC）插线可以进入刷机模式，还可以使用 **灯光和增强功能** 里的<kbd>Reset</kbd>，为了防止误按，需要先按住<kbd>LCtrl</kbd>, 再按这个<kbd>Reset</kbd>，可以直接跳到刷机模式，不用拔线再重插。

<html><div class="attention">
<subtitle>注意</subtitle>
<ul><li>键盘除了 <b>HHKB BLE</b> 可以选择外，也可以使用 <b>HHKB BLE S</b>。</li>
<li>带S的这个固件响应速度更快，暂时无法保证兼容所有HHKB，大部分应该是没问题。</li>
<li>如果你的键盘无兼容问题，强烈推荐选择 <b>HHKB BLE S</b> 的固件。</li><ul>
</div></html>

## 指示灯说明以及节能
除了上面说的BL模式下指示灯作用外。普通的功能可以通过 [LEDMAP](features/ledmap) 定义三个指示灯的功能。指示灯仅在键盘未节能时亮起，建议不要设置需要经常常亮的指示，每颗指示灯一直亮起增加的耗电，会减少键盘的续航。

<html><div class="hint">
<subtitle>提醒</subtitle>
<br>上文提过左边USB口下的红灯是充电指示灯。另外，右边USB下方的那个绿灯等价于LED3。
</div></html>

正面LEDMAP的默认定义，如果要自己修改，请看[LEDMAP](features/ledmap)。

<table_w30x70>

| 指示灯 | 默认配置 |
|:--- |:--- |
| LED1(默认红灯) | CapsLock指示 |
| LED2(默认黄或白灯) | 层1指示（按Fn时会亮） |
| LED3(默认绿灯) | 层2指示 | 

</table_w30x70>

<html><div class="attention">
<subtitle>蓝牙模式下指示灯使用注意</subtitle>
<ul><li>在蓝牙模式下，Num Lock, Caps Lock, Scroll Lock这些指示灯，无法同步显示电脑的这三者状态。</li>
<li>蓝牙模式下，实际是按一下按键就切换显示一次对应指示灯。只有在USB模式下是同步显示的。</li>
<li>不同步时，可使用<kbd>Shift</kbd>+对应按键，如<kbd>Shift</kbd>+<kbd>Capslock</kbd>，这时CapsLock会生效但其指示灯不会变。</li>
<li>合理利用这一点可在蓝牙下反转指示灯使用，如让numlock灯在亮时关，灭时开，可以省电。</li><ul>
</div></html>

除了LEDMAP定义的功能外，还有其他指示一些操作和状态。

<table_w30x70>

| 状态或操作 | LED指示方式 |
|:--- |:--- |
| 刷机模式（空闲） | 三个指示灯一起闪或者交替闪，一直不灭 |
| 刷机模式（数据写入） | 在上面基础上，LED3快速闪烁 |
| 启动时蓝牙 未连接 状态指示 | LED3闪烁，如果一直未连接，约15秒左右会停止闪烁 |
| 启动时蓝牙 已连接 状态指示 | LED2和LED3同时较慢闪。每次亮的时间明显长于灭的时间。 |
| 按键<key>LShift+RShift+s</key> | 按上面的方式指示蓝牙连接状态 |
| 手动进入Lock Mode | 三个灯同时亮起，然后再按LED3 LED2 LED1的顺序依次熄灭 |
| 从二级节能或Lock Mode唤醒 | 三个灯同时亮起，然后开始指示蓝牙连接状态 |
| 低电量提示 | 用键盘时，三个灯同时闪；节能时不闪。依然还可以使用两三天。 |
| 极低电量提示 | 用键盘时，三个灯同时飞快闪；节能时不闪。此时建议尽快充电。 |

</table_w30x70>

<html><div class="hint">
<subtitle>提醒</subtitle>
<ul><li>低电量提示的优先级最高，只要低电量时它会一直指示，同时覆盖其他的。</li> 
<li>只有白色外壳的HHKB可以正面透光，黑色外壳需要查看时可以看背面USB下的LED3（默认绿灯）。</li><ul>
</div></html>


然后关于节能模式的说明：
  1. 键盘闲置3秒没按任何按键后，进入一级节能，此时每30ms再重新检查一次矩阵有无按键，有按键就退出一级节能，这个唤醒过程很快。
  2. 键盘如果90秒蓝牙未连接，或者闲置时间超过2.5小时，这时蓝牙会关闭并断开，进入二级节能。长按任意键3到5秒可以唤醒。
  3. 使用Lock Mode，会直接进入二级节能，与2的区别是，这个模式下，只能同时长按F和J唤醒，不能长按任意键唤醒。

二级节能的功耗是很低的，如果不是特别长期的不用，比如只是第二天不用，可以直接让键盘自己进入二级节能或者直接手动进入Lock Mode（后者更适合放包里，防止意外唤醒）。

## USB HUB
本身自带的接口是miniUSB接口，所以hub这里采用的最高也只支持usb 2.0高速。这些接口禁止接大电流设备，最多接个U盘。不要拿来接其他灯特别多的键盘之类的设备。

<html><div class="attention">
<subtitle>注意</subtitle>
<ul><li>USB HUB接口仅在有线模式下可用。所以，其实美观大于实用。</li>
<li>内部那个USB的电源是默认是关闭的，可以用<kbd>Inner USB</kbd>(默认是<kbd>Fn</kbd>+<kbd>U</kbd>)控制开关。如果要使用，建议内部这个装一个隐藏式迷你U盘。</li></ul>
</div></html>


## Mac下开机进特殊模式

少部分人会遇到有需要使用这个场景，所以这里补充说明一下。

Mac在某次更新后，启动时识别USB键盘需要更长的时间，而HHKB BLE又不想让这个时间拖累蓝牙模式下的启动。暂时采用以下方法，有更好的办法再改进，目前请严格按照以下步骤来。
  1. 首先需要固件是2020-03-16(DK3G)或之后的固件。
  2. 先使用 <kbd>LShift+RShift+LCtrl+w</kbd> 关闭蓝牙功能，务必确定蓝牙功能是关闭的。同时，之后要再使用蓝牙模式请记得再打开。
  3. Mac关机，键盘插上USB线。以进入恢复模式为例，先按Mac的电源开关。这时稍等一下，再按住键盘的 <kbd>Command+R</kbd>，不要提前按。

补充说明：在第3步，如果掌握不好时机，可以在LEDMAP里将LED3的指示灯设置为 **工作模式**，按下 <kbd>Command+r</kbd> 的时机就是按Mac电源开关后，键盘LED3亮起时，亮起说明键盘已经以USB模式启动并可以工作了，在这之前提前按住按键是无效的。

当然，大部分人也不止一个键盘。所以更简单的方法是有这个需求时，拿另外的USB键盘操作。


## Mac下使用Karabiner-Elements

Karabiner-Elements把同一个键盘蓝牙模式和有线模式，是当成不同键盘的。

参考用户提供的说明，要在蓝牙模式下使用Karabiner-Elements，请使用最新版的软件，如下图，勾选上 **[ HHKB BLE(Adafruit Industries) ]** 这一项。

![](/assets/hhkb_karabiner-elements.jpg)


## 异常处理
如果出现按键错误触发或随机触发。请根据淘宝介绍提供的安装说明，确认一下电池和内部USB的母座，与键盘的电路板之间是否做好了绝缘。

工作时如果出现什么异常，最快速的方法是重新插一下usb线或是重新开关一下键盘电源开关。

以及请先参看 [BLE系列排错指南](ble-series/troubleshooting)。

遇到bug可以通过群里联系等方式报给我。

## 硬件版本区别
记录一下售出过的硬件版本的区别，方便以后其他人查看

**v2.5 (仅Pro2版):**
> 1. Bootloader升级，加入简单的检验固件功能，以及刷新成功自动退出。
> 2. 更方便的重置蓝牙功能。使用软件重置时，实际执行硬件重置，可不用手动短接操作（重置的时候LED1和LED3会常亮约5秒，作为指示）。
> 3. 增加一个无线充电模块的接口，可以直接插上使用（但是无线充电接收器放置仍然有一些注意的，见相应的淘宝说明）。
> 4. 为了更好的区分版本，v2.5版使用蓝色的PCB，充电指示灯也使用蓝色（v2.4和v2.3为红色）。

**v2.4B:**
> 1. 与v2.4的区别是，电路上仅支持HHKB JP（包含Type-S）和Pro 1代。
> 2. 无HUB芯片，用户到手的只是支持Pro1或者JP。

**v2.4:**
> 1. 与v2.3的区别是，不再支持5V，仅支持3.3V。
> 2. 仅支持HHKB Pro2（包含Type-S，US布局的）。内部USB母座改到主控PCB上了。

**v2.3:**
> 1. 第一个正式版本。支持5v和3.3v，但是5v电路是未焊接的。
> 2. 电路同时支持HHKB Pro2（包含Type-S，US布局的）和HHKB JP，用户到手的只是支持Pro2或者JP。